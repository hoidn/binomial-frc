# frc

Utilities for single-image Fourier Ring Correlation (FRC) split construction.

## Installation
```bash
pip install -e .
```

## API
- `center_crop_even_square(arr)`: center-crop to an even square canvas.
- `split_diagonal_interleaved(arr)`: diagonal interleaved split into two half-images.
- `split_binomial_thinned(arr, rng_seed=None, count_scale=4096.0)`: independent Poisson half-split.
- `first_below_threshold(curve, threshold)`: first index where a curve falls below threshold.

## Example
```python
import numpy as np

from frc.single_image_frc import (
    center_crop_even_square,
    split_binomial_thinned,
)

img = np.random.rand(96, 96).astype(np.float32)
img = center_crop_even_square(img)

half_a, half_b = split_binomial_thinned(img, rng_seed=123, count_scale=4096.0)
```

## Method (Math)
Let the complex object be

`O(x) = A(x) * exp(i * phi(x))`.

For single-image FRC on amplitude, define an intensity proxy

`lambda(x) = count_scale * |O(x)|^2`.

Then form two statistically independent half-images using Poisson splitting:

`n1(x) ~ Poisson(lambda(x)/2),  n2(x) ~ Poisson(lambda(x)/2)`.

`h1(x) = sqrt(n1(x)/count_scale) * exp(i * angle(O(x)))`,
`h2(x) = sqrt(n2(x)/count_scale) * exp(i * angle(O(x)))`.

Compute FFTs `H1(k), H2(k)` and ring-average by radius `r`. The single-image FRC curve is the signed shell correlation

`FRC(r) = Re(<H1(k) * conj(H2(k))>_r) / sqrt(<|H1(k)|^2>_r * <|H2(k)|^2>_r)`.

Cutoff metrics are first-below-threshold crossings:

`r_t = min { r : FRC(r) < t }`, with `t in {0.5, 1/7}`.

If no crossing occurs, `r_t` is set to the curve length (right-censored at Nyquist).

GT-based FRC uses the same cutoff rule but correlates prediction vs ground-truth images.

## Plot Artifacts
The following plots are generated by the external alignment sweep and saved under `plots/`.

### single_frc50_amp trend
![single_frc50_amp trend](./plots/trend_single_frc50_amp_vs_blur.png)

### Scatter (single_frc50_amp vs ssim_amp)
![scatter](./plots/scatter_single_frc50_amp_vs_ssim_amp.png)

### Scatter by degradation level
![scatter by level](./plots/scatter_single_frc50_amp_vs_ssim_amp_by_level.png)

### single_frc1over7_amp vs GT frc1over7_amp (by degradation level)
This compares no-GT single-image FRC@1/7 (x-axis) against GT-based FRC@1/7 (y-axis).
GT-censored points (`GT FRC@1/7 == curve length`) are excluded in this plot only.
![scatter frc1over7](./plots/scatter_single_frc1over7_amp_vs_gt_frc1over7_amp_by_level_gt_nosat.png)

## Data Artifacts
- `raw_metrics.csv`
- `summary.json`
